package database

import (
	"context"
	"database/sql"
	"fmt"
	"log"
	"time"

	"github.com/Soundveyve/fiber-backend/internal/config"

	// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥—Ä–∞–π–≤–µ—Ä—ã –ë–î
	// _ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –º—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –µ–≥–æ side-effects (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥—Ä–∞–π–≤–µ—Ä–∞)
	_ "github.com/lib/pq" // PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
	// _ "github.com/go-sql-driver/mysql" // MySQL –¥—Ä–∞–π–≤–µ—Ä (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
)

// Database –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
// –≠—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ sql.DB –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –ë–î
type Database struct {
	DB     *sql.DB                // –û–±—ä–µ–∫—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
	Driver string                 // –¢–∏–ø –¥—Ä–∞–π–≤–µ—Ä–∞ (postgres, mysql)
	Config config.DatabaseConfig  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î
}

// NewDatabase —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
// –≠—Ç–æ —Ñ–∞–±—Ä–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
func NewDatabase(cfg config.DatabaseConfig) (*Database, error) {
	// –ü–æ–ª—É—á–∞–µ–º DSN —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
	dsn := cfg.GetDSN()
	if dsn == "" {
		return nil, fmt.Errorf("–Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –¥—Ä–∞–π–≤–µ—Ä –ë–î: %s", cfg.Driver)
	}

	// –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
	// sql.Open –Ω–µ —Å–æ–∑–¥–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É, –∞ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
	db, err := sql.Open(cfg.Driver, dsn)
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ë–î: %w", err)
	}

	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
	// MaxOpenConns –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
	// –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –ë–î –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
	db.SetMaxOpenConns(cfg.MaxOpenConns)
	
	// MaxIdleConns –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–µ—Ä–∂–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è
	// –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
	db.SetMaxIdleConns(cfg.MaxIdleConns)
	
	// ConnMaxLifetime –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫ –¥–æ–ª–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
	// –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ
	// –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å "–ø—Ä–æ—Ç—É—Ö—à–∏–º–∏" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
	db.SetConnMaxLifetime(cfg.ConnMaxLifetime)

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ë–î –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞
	// Ping —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤—è–∑—å
	if err := db.Ping(); err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: %w", err)
	}

	log.Printf("‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (%s) –Ω–∞ %s:%s", 
		cfg.Driver, cfg.Host, cfg.Port)

	return &Database{
		DB:     db,
		Driver: cfg.Driver,
		Config: cfg,
	}, nil
}

// Close –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
// –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–π—Ç–µ Close –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
func (d *Database) Close() error {
	if d.DB != nil {
		log.Println("–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î...")
		return d.DB.Close()
	}
	return nil
}

// HealthCheck –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
// –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è health-check —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≤ API
func (d *Database) HealthCheck() error {
	// –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–ª–∞
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()

	// PingContext –ø—ã—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
	if err := d.DB.PingContext(ctx); err != nil {
		return fmt.Errorf("–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: %w", err)
	}
	
	return nil
}

// GetStats –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
// –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏
func (d *Database) GetStats() sql.DBStats {
	return d.DB.Stats()
}

// LogStats –≤—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ª–æ–≥
func (d *Database) LogStats() {
	stats := d.GetStats()
	log.Printf(`
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î:
   - –û—Ç–∫—Ä—ã—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: %d
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ: %d
   - –ü—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ: %d
   - –û–∂–∏–¥–∞—é—â–∏–µ: %d
   - –ú–∞–∫—Å. –æ—Ç–∫—Ä—ã—Ç—ã—Ö: %d
   - –ú–∞–∫—Å. –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏—Ö: %d
   - –ú–∞–∫—Å. –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏: %v
	`,
		stats.OpenConnections,
		stats.InUse,
		stats.Idle,
		stats.WaitCount,
		d.Config.MaxOpenConns,
		d.Config.MaxIdleConns,
		d.Config.ConnMaxLifetime,
	)
}
